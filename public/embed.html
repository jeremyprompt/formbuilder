<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Embedded Form</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Additional styles for embedded forms */
        body {
            margin: 0;
            padding: 0;
            background: transparent;
        }
        
        .embed-form-container {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 100%;
            margin: 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="embedFormContainer" class="embed-form-container">
        <div class="loading">Loading form...</div>
    </div>

    <script>
        class EmbedFormRenderer {
            constructor() {
                this.formId = this.getFormIdFromUrl();
                this.init();
            }

            getFormIdFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('formId') || urlParams.get('id');
            }

            async init() {
                if (!this.formId) {
                    this.showError('Form ID not provided');
                    return;
                }

                try {
                    await this.loadForm();
                } catch (error) {
                    console.error('Error loading form:', error);
                    this.showError('Failed to load form');
                }
            }

            async loadForm() {
                const response = await fetch(`/api/embed-form?formId=${this.formId}`);
                const data = await response.json();

                if (data.success) {
                    this.renderForm(data.data);
                } else {
                    this.showError(data.message || 'Form not found');
                }
            }

            renderForm(form) {
                const container = document.getElementById('embedFormContainer');
                
                container.innerHTML = `
                    <h2 class="embed-form-title">${form.title}</h2>
                    ${form.description ? `<p class="embed-form-description">${form.description}</p>` : ''}
                    <form id="embedForm" class="embed-form">
                        ${form.fields.map(field => this.renderField(field)).join('')}
                        <button type="submit" class="embed-form-submit">Submit</button>
                    </form>
                    <div id="formMessage" class="hidden"></div>
                `;

                // Add form submission handler
                document.getElementById('embedForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSubmit(e, form);
                });
            }

            renderField(field) {
                const fieldId = `field_${field.id}`;
                const required = field.required ? 'required' : '';
                const requiredStar = field.required ? '<span class="embed-form-required">*</span>' : '';

                switch (field.type) {
                    case 'textarea':
                        return `
                            <div class="embed-form-field">
                                <label for="${fieldId}" class="embed-form-label">
                                    ${field.label} ${requiredStar}
                                </label>
                                <textarea 
                                    id="${fieldId}" 
                                    name="${field.id}" 
                                    class="embed-form-textarea" 
                                    ${required}
                                    placeholder="${field.label}"
                                ></textarea>
                            </div>
                        `;

                    case 'select':
                        return `
                            <div class="embed-form-field">
                                <label for="${fieldId}" class="embed-form-label">
                                    ${field.label} ${requiredStar}
                                </label>
                                <select id="${fieldId}" name="${field.id}" class="embed-form-select" ${required}>
                                    <option value="">Select an option</option>
                                    ${(field.options || []).map(option => 
                                        `<option value="${option}">${option}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        `;

                    case 'radio':
                        return `
                            <div class="embed-form-field">
                                <label class="embed-form-label">
                                    ${field.label} ${requiredStar}
                                </label>
                                <div class="embed-form-radio-group">
                                    ${(field.options || ['Option 1', 'Option 2']).map((option, index) => `
                                        <div class="embed-form-radio">
                                            <input 
                                                type="radio" 
                                                id="${fieldId}_${index}" 
                                                name="${field.id}" 
                                                value="${option}"
                                                ${required}
                                            >
                                            <label for="${fieldId}_${index}">${option}</label>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;

                    case 'checkbox':
                        return `
                            <div class="embed-form-field">
                                <div class="embed-form-checkbox">
                                    <input 
                                        type="checkbox" 
                                        id="${fieldId}" 
                                        name="${field.id}" 
                                        value="true"
                                        ${required}
                                    >
                                    <label for="${fieldId}" class="embed-form-label">
                                        ${field.label} ${requiredStar}
                                    </label>
                                </div>
                            </div>
                        `;

                    default:
                        return `
                            <div class="embed-form-field">
                                <label for="${fieldId}" class="embed-form-label">
                                    ${field.label} ${requiredStar}
                                </label>
                                <input 
                                    type="${field.type}" 
                                    id="${fieldId}" 
                                    name="${field.id}" 
                                    class="embed-form-input" 
                                    ${required}
                                    placeholder="${field.label}"
                                >
                            </div>
                        `;
                }
            }

            async handleSubmit(event, form) {
                const formData = new FormData(event.target);
                const submitButton = event.target.querySelector('.embed-form-submit');
                const messageDiv = document.getElementById('formMessage');

                // Disable submit button
                submitButton.disabled = true;
                submitButton.textContent = 'Submitting...';

                try {
                    // In a real application, you would send this to your backend
                    // For now, we'll just simulate a successful submission
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    // Show success message
                    messageDiv.className = 'embed-form-success';
                    messageDiv.textContent = 'Thank you! Your form has been submitted successfully.';
                    messageDiv.classList.remove('hidden');

                    // Reset form
                    event.target.reset();

                } catch (error) {
                    console.error('Error submitting form:', error);
                    messageDiv.className = 'embed-form-error';
                    messageDiv.textContent = 'Sorry, there was an error submitting your form. Please try again.';
                    messageDiv.classList.remove('hidden');
                } finally {
                    // Re-enable submit button
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit';
                }
            }

            showError(message) {
                const container = document.getElementById('embedFormContainer');
                container.innerHTML = `
                    <div class="embed-form-error">
                        <h3>Error</h3>
                        <p>${message}</p>
                    </div>
                `;
            }
        }

        // Initialize the embed form renderer
        new EmbedFormRenderer();
    </script>
</body>
</html>
